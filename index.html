<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="/manifest.json" />
  <title>Document</title>
  <style>
    * {
      font-size: 1.5rem;
    }
  </style>
</head>
<body>
  <div>Auth key: <span id="auth-key"></span></div>
  <button onclick="setKey()">Set auth key</button>
  <div>
    <section>
      <h1>Location data</h1>
      <button onclick="start()">Start tracking location</button>
      <button onclick="stop()">Stop tracking location</button>
      <ol id="request-result"></ol>
    </section>
    <section>
      <h1>Data in server</h1>
      <button onclick="show()">Show data</button>
      <button onclick="clearDb()">Clear data</button>
      <ol id="db-data"></ol>
    </section>
  </div>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
    let key = '';
    let watchId = -1;
    let walkDistance = 0;
    let prevLatitude = 0;
    let prevLongitude = 0;
    const dbUrl = 'https://geofencing-poc-6e77c-default-rtdb.asia-southeast1.firebasedatabase.app';
    const setKey = () => {
      const newKey = prompt('Please set auth key', '');
      if (newKey) {
        document.getElementById('auth-key').innerHTML = newKey;
        key = newKey;
      }
    }
    const start = () => {
      const url = getUrl();
      if (url) {
        const requestReuslt = document.getElementById('request-result');
        requestReuslt.innerHTML = '<li>Start...</li>';
        watchId = navigator.geolocation.watchPosition((position) => {
          const {latitude, longitude} = position.coords;
          const locationData = `${latitude}, ${longitude}`;
          if (!(walkDistance === 0 && prevLatitude === 0 && prevLongitude === 0)) {
            walkDistance = Math.abs(latitude - prevLatitude) + Math.abs(longitude - prevLongitude);
          }
          prevLatitude = latitude;
          prevLongitude = longitude;
          requestReuslt.innerHTML += `<li>${new Date().toLocaleString()}, ${locationData}, ${walkDistance}</li>`;
          if (walkDistance > 0.00005) {
            fetch(url, {
              method: 'POST',
              body: JSON.stringify({
                data: `${new Date().toLocaleString()}, ${locationData}, ${walkDistance}`,
              })
            })
            stop();
          }
        });
      }
    }
    const stop = () => {
      navigator.geolocation.clearWatch(watchId);
      const requestReuslt = document.getElementById('request-result');
      requestReuslt.innerHTML += '<li>Stop</li>';
      walkDistance = 0;
      prevLatitude = 0;
      prevLongitude = 0;
    }
    const clearDb = () => {
      const url = getUrl();
      if (url) {
        fetch(url, {
          method: 'DELETE',
        }).then(response => {
          if (response.ok) {
            const dbData = document.getElementById('db-data');
            dbData.innerHTML = '';
            alert('deleted');
          }
        })
      }
    }
    const show = () => {
      const url = getUrl();
      if (url) {
        fetch(url)
        .then(response => response.json())
        .then(result => {
          const dbData = document.getElementById('db-data');
          dbData.innerHTML = '';
          if (result) {
            Object.values(result).forEach(obj => dbData.innerHTML += `<li>${obj.data}</li>`);
          }
        });
      }
    }
    const getUrl = () => {
      if (key) {
        return `${dbUrl}/${key}/messages.json`;
      }
      alert('Please set auth key');
      return '';
    };
  </script>
</body>
</html>